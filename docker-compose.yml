x-policy-server-image-build: &policy_server
  build:
    context: .
    ssh:
      default:
    dockerfile: Dockerfile.policyserver


x-deploy: &gpu_deploy
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: 1
            capabilities: [gpu]

networks:
  policy-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

services:
  policy-server:
    volumes:
      - ~/.cache/openpi:/root/.cache/openpi
    ports:
      - "8000:8000"
    environment:
      - MODEL_NAME=${MODEL_NAME:-pi0_fast_rainbow_poc}
      - CHECKPOINT_PATH=${CHECKPOINT_PATH:-s3://hm-vla/checkpoints/pi0_fast_rainbow_poc/pi0_rainbow_poc_chips/20000}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      # JAX/CUDA configuration
      # - XLA_FLAGS=--xla_gpu_cuda_data_dir=/usr/local/cuda
      # - JAX_PLATFORM_NAME=cuda
      # - JAX_PLATFORMS=cuda
      # - JAX_ENABLE_X64=True
    networks:
      - policy-net
    runtime: nvidia
    <<: [ *policy_server, *gpu_deploy ]